<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced User-Level Thread Library</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00b4db, #0083b0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .test-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .test-title {
            font-size: 1.4em;
            font-weight: bold;
        }
        
        .test-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-completed {
            background: rgba(46, 204, 113, 0.3);
            color: #2ecc71;
        }
        
        .thread-visualization {
            margin: 15px 0;
            height: 120px;
            position: relative;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .thread {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8em;
            transition: all 0.5s ease;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .thread-ready { background: #3498db; }
        .thread-running { background: #2ecc71; }
        .thread-blocked { background: #e74c3c; }
        .thread-terminated { background: #95a5a6; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .stat-value {
            font-weight: bold;
            color: #3498db;
        }
        
        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00b4db, #0083b0);
            border-radius: 3px;
            transition: width 1s ease;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .control-btn {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }
        
        .week4-buffer {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .buffer-items {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        .buffer-item {
            width: 30px;
            height: 30px;
            background: rgba(52, 152, 219, 0.3);
            border: 1px solid #3498db;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
        }
        
        .buffer-item.filled {
            background: rgba(46, 204, 113, 0.3);
            border-color: #2ecc71;
        }
        
        .timeline {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            margin: 15px 0;
            position: relative;
            border-radius: 2px;
        }
        
        .timeline-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #f39c12;
            border-radius: 50%;
            top: -4px;
            transform: translateX(-50%);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 1s infinite;
        }
        
        .console-output {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.4;
        }
        
        .console-line {
            margin-bottom: 3px;
        }
        
        .console-thread-1 { color: #3498db; }
        .console-thread-2 { color: #2ecc71; }
        .console-thread-3 { color: #e74c3c; }
        .console-thread-4 { color: #f39c12; }
        .console-thread-5 { color: #9b59b6; }
        .console-thread-6 { color: #1abc9c; }
        .console-system { color: #ecf0f1; }
        .console-preemption { color: #f1c40f; font-weight: bold; }
        .console-join { color: #95a5a6; }
        .console-producer { color: #3498db; }
        .console-consumer { color: #2ecc71; }
        .console-success { color: #2ecc71; font-weight: bold; }
        
        .completion-banner {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: rgba(46, 204, 113, 0.2);
            border-radius: 15px;
            border: 1px solid rgba(46, 204, 113, 0.5);
            font-size: 1.5em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Enhanced User-Level Thread Library</h1>
            <p>Visualization of Multi-Week Test Execution</p>
        </div>
        
        <div class="controls">
            <button class="control-btn" onclick="startVisualization()">Start Visualization</button>
            <button class="control-btn" onclick="pauseVisualization()">Pause</button>
            <button class="control-btn" onclick="resetVisualization()">Reset</button>
            <button class="control-btn" onclick="speedUp()">Speed Up</button>
            <button class="control-btn" onclick="slowDown()">Slow Down</button>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #3498db;"></div>
                <span>Ready</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #2ecc71;"></div>
                <span>Running</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c;"></div>
                <span>Blocked</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #95a5a6;"></div>
                <span>Terminated</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f39c12;"></div>
                <span>Preemption</span>
            </div>
        </div>
        
        <div class="test-container">
            <!-- Week 1: Cooperative Threading -->
            <div class="test-card">
                <div class="test-header">
                    <div class="test-title">Week 1: Cooperative Threading</div>
                    <div class="test-status status-completed">Completed</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="week1-progress" style="width: 0%"></div>
                </div>
                <div class="thread-visualization" id="week1-visualization">
                    <!-- Threads will be dynamically added here -->
                </div>
                <div class="console-output" id="week1-console"></div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span>Threads Created:</span>
                        <span class="stat-value" id="week1-created">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Threads Terminated:</span>
                        <span class="stat-value" id="week1-terminated">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Context Switches:</span>
                        <span class="stat-value" id="week1-switches">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Voluntary Yields:</span>
                        <span class="stat-value" id="week1-yields">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Week 2: Preemption + Mutex -->
            <div class="test-card">
                <div class="test-header">
                    <div class="test-title">Week 2: Preemption + Mutex</div>
                    <div class="test-status status-completed">Completed</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="week2-progress" style="width: 0%"></div>
                </div>
                <div class="thread-visualization" id="week2-visualization">
                    <!-- Threads will be dynamically added here -->
                </div>
                <div class="timeline" id="week2-timeline">
                    <!-- Preemption markers will be added here -->
                </div>
                <div class="console-output" id="week2-console"></div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span>Final Counter:</span>
                        <span class="stat-value" id="week2-counter">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Preemptions:</span>
                        <span class="stat-value" id="week2-preemptions">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Mutex Blocks:</span>
                        <span class="stat-value" id="week2-mutex-blocks">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Context Switches:</span>
                        <span class="stat-value" id="week2-switches">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Week 3: Priority Scheduling -->
            <div class="test-card">
                <div class="test-header">
                    <div class="test-title">Week 3: Priority Scheduling</div>
                    <div class="test-status status-completed">Completed</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="week3-progress" style="width: 0%"></div>
                </div>
                <div class="thread-visualization" id="week3-visualization">
                    <!-- Threads will be dynamically added here -->
                </div>
                <div class="console-output" id="week3-console"></div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span>Thread 1 Priority:</span>
                        <span class="stat-value">1 (Low)</span>
                    </div>
                    <div class="stat-item">
                        <span>Thread 2 Priority:</span>
                        <span class="stat-value">3 (High)</span>
                    </div>
                    <div class="stat-item">
                        <span>Thread 3 Priority:</span>
                        <span class="stat-value">2 (Medium)</span>
                    </div>
                    <div class="stat-item">
                        <span>Context Switches:</span>
                        <span class="stat-value" id="week3-switches">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Week 4: Condition Variables -->
            <div class="test-card">
                <div class="test-header">
                    <div class="test-title">Week 4: Condition Variables</div>
                    <div class="test-status status-completed">Completed</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="week4-progress" style="width: 0%"></div>
                </div>
                <div class="thread-visualization" id="week4-visualization">
                    <!-- Threads will be dynamically added here -->
                </div>
                <div class="week4-buffer">
                    <div>Producer-Consumer Buffer (Size: 5)</div>
                    <div class="buffer-items" id="week4-buffer-items">
                        <div class="buffer-item"></div>
                        <div class="buffer-item"></div>
                        <div class="buffer-item"></div>
                        <div class="buffer-item"></div>
                        <div class="buffer-item"></div>
                    </div>
                </div>
                <div class="console-output" id="week4-console"></div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span>Producers:</span>
                        <span class="stat-value">3</span>
                    </div>
                    <div class="stat-item">
                        <span>Consumers:</span>
                        <span class="stat-value">3</span>
                    </div>
                    <div class="stat-item">
                        <span>Items Produced:</span>
                        <span class="stat-value" id="week4-produced">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Items Consumed:</span>
                        <span class="stat-value" id="week4-consumed">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="header" style="margin-top: 30px;">
            <h2>Overall Statistics</h2>
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-top: 20px;">
                <div class="stat-item">
                    <span>Total Threads Created:</span>
                    <span class="stat-value" id="total-created">0</span>
                </div>
                <div class="stat-item">
                    <span>Total Threads Terminated:</span>
                    <span class="stat-value" id="total-terminated">0</span>
                </div>
                <div class="stat-item">
                    <span>Total Context Switches:</span>
                    <span class="stat-value" id="total-switches">0</span>
                </div>
                <div class="stat-item">
                    <span>Total Preemptions:</span>
                    <span class="stat-value" id="total-preemptions">0</span>
                </div>
            </div>
        </div>
        
        <div class="completion-banner" id="completion-banner" style="display: none;">
            ðŸŽ‰ ALL TESTS COMPLETED! ðŸŽ‰
        </div>
    </div>

    <script>
        // Visualization state
        let visualizationState = {
            currentWeek: 0,
            speed: 1000,
            isRunning: false,
            intervalId: null,
            week1: {
                step: 0,
                threads: [
                    { id: 1, state: 'ready', steps: 3, currentStep: 0 },
                    { id: 2, state: 'ready', steps: 3, currentStep: 0 },
                    { id: 3, state: 'ready', steps: 3, currentStep: 0 }
                ],
                stats: { created: 3, terminated: 0, switches: 0, yields: 0 },
                console: []
            },
            week2: {
                step: 0,
                threads: [
                    { id: 1, state: 'ready', steps: 3, currentStep: 0, inCritical: false },
                    { id: 2, state: 'ready', steps: 3, currentStep: 0, inCritical: false }
                ],
                stats: { counter: 0, preemptions: 0, mutexBlocks: 0, switches: 0 },
                preemptionPoints: [2, 4, 6],
                console: []
            },
            week3: {
                step: 0,
                threads: [
                    { id: 1, state: 'ready', steps: 3, currentStep: 0, priority: 1 },
                    { id: 2, state: 'ready', steps: 3, currentStep: 0, priority: 3 },
                    { id: 3, state: 'ready', steps: 3, currentStep: 0, priority: 2 }
                ],
                stats: { switches: 0 },
                console: []
            },
            week4: {
                step: 0,
                producers: [
                    { id: 1, state: 'ready', items: 10, produced: 0 },
                    { id: 2, state: 'ready', items: 10, produced: 0 },
                    { id: 3, state: 'ready', items: 10, produced: 0 }
                ],
                consumers: [
                    { id: 4, state: 'ready', items: 10, consumed: 0 },
                    { id: 5, state: 'ready', items: 10, consumed: 0 },
                    { id: 6, state: 'ready', items: 10, consumed: 0 }
                ],
                buffer: [0, 0, 0, 0, 0],
                stats: { produced: 0, consumed: 0 },
                console: []
            }
        };

        // Initialize visualization
        function initializeVisualization() {
            createThreadVisualizations();
            updateOverallStats();
        }

        // Create thread visualization elements
        function createThreadVisualizations() {
            // Week 1
            const week1Viz = document.getElementById('week1-visualization');
            week1Viz.innerHTML = '';
            visualizationState.week1.threads.forEach(thread => {
                const threadEl = document.createElement('div');
                threadEl.className = `thread thread-${thread.state}`;
                threadEl.id = `week1-thread-${thread.id}`;
                threadEl.textContent = thread.id;
                week1Viz.appendChild(threadEl);
            });
            positionThreads('week1');

            // Week 2
            const week2Viz = document.getElementById('week2-visualization');
            week2Viz.innerHTML = '';
            visualizationState.week2.threads.forEach(thread => {
                const threadEl = document.createElement('div');
                threadEl.className = `thread thread-${thread.state}`;
                threadEl.id = `week2-thread-${thread.id}`;
                threadEl.textContent = thread.id;
                week2Viz.appendChild(threadEl);
            });
            positionThreads('week2');

            // Week 3
            const week3Viz = document.getElementById('week3-visualization');
            week3Viz.innerHTML = '';
            visualizationState.week3.threads.forEach(thread => {
                const threadEl = document.createElement('div');
                threadEl.className = `thread thread-${thread.state}`;
                threadEl.id = `week3-thread-${thread.id}`;
                threadEl.textContent = thread.id;
                threadEl.title = `Priority: ${thread.priority}`;
                week3Viz.appendChild(threadEl);
            });
            positionThreads('week3');

            // Week 4
            const week4Viz = document.getElementById('week4-visualization');
            week4Viz.innerHTML = '';
            [...visualizationState.week4.producers, ...visualizationState.week4.consumers].forEach(thread => {
                const threadEl = document.createElement('div');
                threadEl.className = `thread thread-${thread.state}`;
                threadEl.id = `week4-thread-${thread.id}`;
                threadEl.textContent = thread.id;
                threadEl.title = thread.id <= 3 ? 'Producer' : 'Consumer';
                week4Viz.appendChild(threadEl);
            });
            positionThreads('week4');
        }

        // Position threads in visualization container
        function positionThreads(week) {
            const container = document.getElementById(`${week}-visualization`);
            const threads = container.getElementsByClassName('thread');
            const containerWidth = container.offsetWidth;
            const containerHeight = container.offsetHeight;
            
            Array.from(threads).forEach((threadEl, index) => {
                const threadId = parseInt(threadEl.textContent);
                let x, y;
                
                if (week === 'week4') {
                    // Special layout for producers and consumers
                    if (threadId <= 3) {
                        // Producers on left
                        x = 20 + (threadId - 1) * 40;
                        y = containerHeight / 3;
                    } else {
                        // Consumers on right
                        x = containerWidth - 100 + (threadId - 4) * 40;
                        y = containerHeight / 3;
                    }
                } else {
                    // Even distribution for other weeks
                    x = 20 + (index % 4) * (containerWidth - 40) / 4;
                    y = 20 + Math.floor(index / 4) * (containerHeight - 40) / 2;
                }
                
                threadEl.style.left = `${x}px`;
                threadEl.style.top = `${y}px`;
            });
        }

        // Start visualization
        function startVisualization() {
            if (visualizationState.isRunning) return;
            
            visualizationState.isRunning = true;
            visualizationState.intervalId = setInterval(advanceVisualization, visualizationState.speed);
        }

        // Pause visualization
        function pauseVisualization() {
            visualizationState.isRunning = false;
            if (visualizationState.intervalId) {
                clearInterval(visualizationState.intervalId);
                visualizationState.intervalId = null;
            }
        }

        // Reset visualization
        function resetVisualization() {
            pauseVisualization();
            visualizationState = {
                currentWeek: 0,
                speed: 1000,
                isRunning: false,
                intervalId: null,
                week1: {
                    step: 0,
                    threads: [
                        { id: 1, state: 'ready', steps: 3, currentStep: 0 },
                        { id: 2, state: 'ready', steps: 3, currentStep: 0 },
                        { id: 3, state: 'ready', steps: 3, currentStep: 0 }
                    ],
                    stats: { created: 3, terminated: 0, switches: 0, yields: 0 },
                    console: []
                },
                week2: {
                    step: 0,
                    threads: [
                        { id: 1, state: 'ready', steps: 3, currentStep: 0, inCritical: false },
                        { id: 2, state: 'ready', steps: 3, currentStep: 0, inCritical: false }
                    ],
                    stats: { counter: 0, preemptions: 0, mutexBlocks: 0, switches: 0 },
                    preemptionPoints: [2, 4, 6],
                    console: []
                },
                week3: {
                    step: 0,
                    threads: [
                        { id: 1, state: 'ready', steps: 3, currentStep: 0, priority: 1 },
                        { id: 2, state: 'ready', steps: 3, currentStep: 0, priority: 3 },
                        { id: 3, state: 'ready', steps: 3, currentStep: 0, priority: 2 }
                    ],
                    stats: { switches: 0 },
                    console: []
                },
                week4: {
                    step: 0,
                    producers: [
                        { id: 1, state: 'ready', items: 10, produced: 0 },
                        { id: 2, state: 'ready', items: 10, produced: 0 },
                        { id: 3, state: 'ready', items: 10, produced: 0 }
                    ],
                    consumers: [
                        { id: 4, state: 'ready', items: 10, consumed: 0 },
                        { id: 5, state: 'ready', items: 10, consumed: 0 },
                        { id: 6, state: 'ready', items: 10, consumed: 0 }
                    ],
                    buffer: [0, 0, 0, 0, 0],
                    stats: { produced: 0, consumed: 0 },
                    console: []
                }
            };
            initializeVisualization();
            updateAllDisplays();
            clearConsoles();
            document.getElementById('completion-banner').style.display = 'none';
        }

        // Speed up visualization
        function speedUp() {
            visualizationState.speed = Math.max(100, visualizationState.speed / 2);
            if (visualizationState.isRunning) {
                pauseVisualization();
                startVisualization();
            }
        }

        // Slow down visualization
        function slowDown() {
            visualizationState.speed = Math.min(3000, visualizationState.speed * 2);
            if (visualizationState.isRunning) {
                pauseVisualization();
                startVisualization();
            }
        }

        // Advance visualization step by step
        function advanceVisualization() {
            visualizationState.currentWeek++;
            if (visualizationState.currentWeek > 4) {
                visualizationState.currentWeek = 1;
            }

            switch (visualizationState.currentWeek) {
                case 1:
                    advanceWeek1();
                    break;
                case 2:
                    advanceWeek2();
                    break;
                case 3:
                    advanceWeek3();
                    break;
                case 4:
                    advanceWeek4();
                    break;
            }

            updateAllDisplays();
            
            // Check if all tests are completed
            if (visualizationState.week1.step >= 7 && visualizationState.week2.step >= 7 && 
                visualizationState.week3.step >= 7 && visualizationState.week4.step >= 36) {
                document.getElementById('completion-banner').style.display = 'block';
                pauseVisualization();
            }
        }

        // Advance Week 1 simulation
        function advanceWeek1() {
            const week = visualizationState.week1;
            week.step++;
            
            // Add console output based on step
            if (week.step === 1) {
                addConsoleOutput('week1', '=== Week 1: Cooperative Threading ===', 'system');
                addConsoleOutput('week1', 'Thread 1: starting', 'thread-1');
                addConsoleOutput('week1', 'Thread 1: step 0', 'thread-1');
                
                // Update thread states
                week.threads[0].state = 'running';
            } else if (week.step === 2) {
                addConsoleOutput('week1', 'Thread 2: starting', 'thread-2');
                addConsoleOutput('week1', 'Thread 2: step 0', 'thread-2');
                addConsoleOutput('week1', 'Thread 3: starting', 'thread-3');
                addConsoleOutput('week1', 'Thread 3: step 0', 'thread-3');
                
                // Update thread states
                week.threads[0].state = 'ready';
                week.threads[1].state = 'running';
                week.threads[2].state = 'ready';
                week.stats.switches += 2;
                week.stats.yields += 1;
            } else if (week.step === 3) {
                addConsoleOutput('week1', 'Thread 1: step 1', 'thread-1');
                addConsoleOutput('week1', 'Thread 2: step 1', 'thread-2');
                addConsoleOutput('week1', 'Thread 3: step 1', 'thread-3');
                
                // Update thread states
                week.threads[0].state = 'running';
                week.threads[1].state = 'ready';
                week.threads[2].state = 'ready';
                week.stats.switches += 3;
                week.stats.yields += 3;
            } else if (week.step === 4) {
                addConsoleOutput('week1', 'Thread 1: step 2', 'thread-1');
                addConsoleOutput('week1', 'Thread 2: step 2', 'thread-2');
                addConsoleOutput('week1', 'Thread 3: step 2', 'thread-3');
                
                // Update thread states
                week.threads[0].state = 'ready';
                week.threads[1].state = 'running';
                week.threads[2].state = 'ready';
                week.stats.switches += 3;
                week.stats.yields += 3;
            } else if (week.step === 5) {
                addConsoleOutput('week1', 'Thread 1: exiting', 'thread-1');
                addConsoleOutput('week1', 'Thread 2: exiting', 'thread-2');
                addConsoleOutput('week1', 'Thread 3: exiting', 'thread-3');
                addConsoleOutput('week1', 'Join results: 100, 200, 300', 'join');
                
                // Update thread states
                week.threads[0].state = 'terminated';
                week.threads[1].state = 'terminated';
                week.threads[2].state = 'terminated';
                week.stats.terminated = 3;
                week.stats.switches += 3;
                week.stats.yields += 3;
            } else if (week.step === 6) {
                addConsoleOutput('week1', '=== Thread Statistics ===', 'system');
                addConsoleOutput('week1', 'Threads created: 3', 'system');
                addConsoleOutput('week1', 'Threads terminated: 3', 'system');
                addConsoleOutput('week1', 'Total context switches: 21', 'system');
                addConsoleOutput('week1', '  Voluntary yields: 9', 'system');
                addConsoleOutput('week1', '  Preemptions: 0', 'system');
                addConsoleOutput('week1', '  Mutex blocks: 0', 'system');
                addConsoleOutput('week1', 'Active threads: 0', 'system');
                addConsoleOutput('week1', 'Preemption enabled: NO', 'system');
                addConsoleOutput('week1', 'Multi-core enabled: NO', 'system');
                addConsoleOutput('week1', 'Kernel threads: 0', 'system');
                addConsoleOutput('week1', 'Scheduling policy: Round-Robin', 'system');
            }
            
            // Update progress
            const progress = (week.step / 6) * 100;
            document.getElementById('week1-progress').style.width = `${Math.min(100, progress)}%`;
        }

        // Advance Week 2 simulation
        function advanceWeek2() {
            const week = visualizationState.week2;
            week.step++;
            
            // Add console output based on step
            if (week.step === 1) {
                addConsoleOutput('week2', '=== Week 2: Preemption + Mutex ===', 'system');
                addConsoleOutput('week2', '[Preemption ENABLED]', 'system');
                addConsoleOutput('week2', 'Thread 1: starting', 'thread-1');
                addConsoleOutput('week2', 'Thread 1: counter=0', 'thread-1');
                
                // Update thread states
                week.threads[0].state = 'running';
                week.stats.counter = 0;
            } else if (week.step === 2) {
                addConsoleOutput('week2', 'Thread 2: starting', 'thread-2');
                addConsoleOutput('week2', 'Thread 2: counter=1', 'thread-2');
                
                // Update thread states
                week.threads[0].state = 'ready';
                week.threads[1].state = 'running';
                week.stats.counter = 1;
                week.stats.switches += 2;
            } else if (week.step === 3) {
                addConsoleOutput('week2', '[PREEMPTION!] Thread 2', 'preemption');
                addConsoleOutput('week2', 'Thread 1: counter=2', 'thread-1');
                
                // Update thread states
                week.threads[0].state = 'running';
                week.threads[1].state = 'ready';
                week.stats.counter = 2;
                week.stats.preemptions++;
                week.stats.switches += 2;
                addPreemptionMarker(week.step);
            } else if (week.step === 4) {
                addConsoleOutput('week2', '[PREEMPTION!] Thread 1', 'preemption');
                addConsoleOutput('week2', 'Thread 2: counter=3', 'thread-2');
                
                // Update thread states
                week.threads[0].state = 'ready';
                week.threads[1].state = 'running';
                week.stats.counter = 3;
                week.stats.preemptions++;
                week.stats.switches += 2;
                addPreemptionMarker(week.step);
            } else if (week.step === 5) {
                addConsoleOutput('week2', '[PREEMPTION!] Thread 2', 'preemption');
                addConsoleOutput('week2', 'Thread 1: counter=4', 'thread-1');
                
                // Update thread states
                week.threads[0].state = 'running';
                week.threads[1].state = 'ready';
                week.stats.counter = 4;
                week.stats.preemptions++;
                week.stats.switches += 2;
                addPreemptionMarker(week.step);
            } else if (week.step === 6) {
                addConsoleOutput('week2', 'Thread 2: counter=5', 'thread-2');
                addConsoleOutput('week2', 'Thread 1: exiting', 'thread-1');
                addConsoleOutput('week2', 'Thread 2: exiting', 'thread-2');
                addConsoleOutput('week2', '[Preemption DISABLED]', 'system');
                addConsoleOutput('week2', 'Final counter: 6 (expected: 6)', 'system');
                
                // Update thread states
                week.threads[0].state = 'terminated';
                week.threads[1].state = 'terminated';
                week.stats.counter = 6;
                week.stats.switches += 2;
            } else if (week.step === 7) {
                addConsoleOutput('week2', '=== Thread Statistics ===', 'system');
                addConsoleOutput('week2', 'Threads created: 2', 'system');
                addConsoleOutput('week2', 'Threads terminated: 2', 'system');
                addConsoleOutput('week2', 'Total context switches: 14', 'system');
                addConsoleOutput('week2', '  Voluntary yields: 6', 'system');
                addConsoleOutput('week2', '  Preemptions: 3', 'system');
                addConsoleOutput('week2', '  Mutex blocks: 0', 'system');
                addConsoleOutput('week2', 'Active threads: 0', 'system');
                addConsoleOutput('week2', 'Preemption enabled: NO', 'system');
                addConsoleOutput('week2', 'Multi-core enabled: NO', 'system');
                addConsoleOutput('week2', 'Kernel threads: 0', 'system');
                addConsoleOutput('week2', 'Scheduling policy: Round-Robin', 'system');
            }
            
            // Update progress
            const progress = (week.step / 7) * 100;
            document.getElementById('week2-progress').style.width = `${Math.min(100, progress)}%`;
        }

        // Add preemption marker to timeline
        function addPreemptionMarker(step) {
            const timeline = document.getElementById('week2-timeline');
            const marker = document.createElement('div');
            marker.className = 'timeline-marker preemption-marker pulse';
            marker.style.left = `${(step / 7) * 100}%`;
            timeline.appendChild(marker);
        }

        // Advance Week 3 simulation
        function advanceWeek3() {
            const week = visualizationState.week3;
            week.step++;
            
            // Add console output based on step
            if (week.step === 1) {
                addConsoleOutput('week3', '=== Week 3: Priority Test (No Preemption) ===', 'system');
                addConsoleOutput('week3', 'Scheduling policy set to: Priority', 'system');
                addConsoleOutput('week3', 'Thread 2 (priority 3): step 0', 'thread-2');
                
                // Update thread states
                week.threads[1].state = 'running';
                week.threads[0].state = 'ready';
                week.threads[2].state = 'ready';
                week.stats.switches++;
            } else if (week.step === 2) {
                addConsoleOutput('week3', 'Thread 3 (priority 2): step 0', 'thread-3');
                
                // Update thread states
                week.threads[1].state = 'running';
                week.threads[0].state = 'ready';
                week.threads[2].state = 'ready';
                week.stats.switches++;
            } else if (week.step === 3) {
                addConsoleOutput('week3', 'Thread 2 (priority 3): step 1', 'thread-2');
                
                // Update thread states
                week.threads[1].state = 'running';
                week.threads[0].state = 'ready';
                week.threads[2].state = 'ready';
                week.stats.switches++;
            } else if (week.step === 4) {
                addConsoleOutput('week3', 'Thread 1 (priority 1): step 0', 'thread-1');
                addConsoleOutput('week3', 'Thread 3 (priority 2): step 1', 'thread-3');
                
                // Update thread states
                week.threads[1].state = 'running';
                week.threads[0].state = 'ready';
                week.threads[2].state = 'ready';
                week.stats.switches += 2;
            } else if (week.step === 5) {
                addConsoleOutput('week3', 'Thread 2 (priority 3): step 2', 'thread-2');
                addConsoleOutput('week3', 'Thread 1 (priority 1): step 1', 'thread-1');
                addConsoleOutput('week3', 'Thread 3 (priority 2): step 2', 'thread-3');
                
                // Update thread states
                week.threads[1].state = 'running';
                week.threads[0].state = 'ready';
                week.threads[2].state = 'ready';
                week.stats.switches += 3;
            } else if (week.step === 6) {
                addConsoleOutput('week3', 'Thread 2: exiting', 'thread-2');
                addConsoleOutput('week3', 'Thread 1 (priority 1): step 2', 'thread-1');
                addConsoleOutput('week3', 'Thread 3: exiting', 'thread-3');
                addConsoleOutput('week3', 'Thread 1: exiting', 'thread-1');
                addConsoleOutput('week3', 'Join results: 100, 200, 300', 'join');
                
                // Update thread states
                week.threads[0].state = 'terminated';
                week.threads[1].state = 'terminated';
                week.threads[2].state = 'terminated';
                week.stats.switches += 3;
            } else if (week.step === 7) {
                addConsoleOutput('week3', '=== Thread Statistics ===', 'system');
                addConsoleOutput('week3', 'Threads created: 3', 'system');
                addConsoleOutput('week3', 'Threads terminated: 3', 'system');
                addConsoleOutput('week3', 'Total context switches: 21', 'system');
                addConsoleOutput('week3', '  Voluntary yields: 9', 'system');
                addConsoleOutput('week3', '  Preemptions: 0', 'system');
                addConsoleOutput('week3', '  Mutex blocks: 0', 'system');
                addConsoleOutput('week3', 'Active threads: 0', 'system');
                addConsoleOutput('week3', 'Preemption enabled: NO', 'system');
                addConsoleOutput('week3', 'Multi-core enabled: NO', 'system');
                addConsoleOutput('week3', 'Kernel threads: 0', 'system');
                addConsoleOutput('week3', 'Scheduling policy: Priority', 'system');
            }
            
            // Update progress
            const progress = (week.step / 7) * 100;
            document.getElementById('week3-progress').style.width = `${Math.min(100, progress)}%`;
        }

        // Advance Week 4 simulation
        function advanceWeek4() {
            const week = visualizationState.week4;
            week.step++;
            
            // Add console output based on step
            if (week.step === 1) {
                addConsoleOutput('week4', '=== Week 4: Condition Variables (Safe Cleanup) ===', 'system');
                addConsoleOutput('week4', '[Preemption ENABLED]', 'system');
                addConsoleOutput('week4', 'Creating 3 producers and 3 consumers...', 'system');
                addConsoleOutput('week4', 'Created producer 1 (thread 1)', 'producer');
                addConsoleOutput('week4', 'Created producer 2 (thread 2)', 'producer');
                addConsoleOutput('week4', 'Created producer 3 (thread 3)', 'producer');
                addConsoleOutput('week4', 'Created consumer 1 (thread 4)', 'consumer');
                addConsoleOutput('week4', 'Created consumer 2 (thread 5)', 'consumer');
                addConsoleOutput('week4', 'Created consumer 3 (thread 6)', 'consumer');
                addConsoleOutput('week4', 'Starting scheduler...', 'system');
                
                // Update thread states
                week.producers[0].state = 'running';
                week.producers[1].state = 'ready';
                week.producers[2].state = 'ready';
                week.consumers[0].state = 'ready';
                week.consumers[1].state = 'ready';
                week.consumers[2].state = 'ready';
            } else if (week.step >= 2 && week.step <= 31) {
                // Simulate producer-consumer activity
                const cycle = (week.step - 2) % 10;
                
                if (cycle === 0) {
                    // Producers produce
                    week.producers.forEach((producer, index) => {
                        if (producer.produced < producer.items) {
                            const emptySlot = week.buffer.indexOf(0);
                            if (emptySlot !== -1) {
                                week.buffer[emptySlot] = producer.id * 100 + producer.produced;
                                producer.produced++;
                                week.stats.produced++;
                                producer.state = 'running';
                                addConsoleOutput('week4', `Producer ${producer.id} produced item ${producer.id * 100 + producer.produced - 1} (count: ${week.buffer.filter(x => x !== 0).length})`, 'producer');
                                
                                setTimeout(() => { 
                                    producer.state = 'ready'; 
                                    updateThreadVisualizations();
                                }, 200);
                            } else {
                                producer.state = 'blocked';
                            }
                        }
                    });
                } else if (cycle === 5) {
                    // Consumers consume
                    week.consumers.forEach((consumer, index) => {
                        if (consumer.consumed < consumer.items) {
                            const fullSlot = week.buffer.findIndex(item => item !== 0);
                            if (fullSlot !== -1) {
                                const item = week.buffer[fullSlot];
                                week.buffer[fullSlot] = 0;
                                consumer.consumed++;
                                week.stats.consumed++;
                                consumer.state = 'running';
                                addConsoleOutput('week4', `Consumer ${consumer.id} consumed item ${item} (count: ${week.buffer.filter(x => x !== 0).length})`, 'consumer');
                                
                                setTimeout(() => { 
                                    consumer.state = 'ready'; 
                                    updateThreadVisualizations();
                                }, 200);
                            } else {
                                consumer.state = 'blocked';
                            }
                        }
                    });
                }
                
                updateBufferDisplay();
            } else if (week.step === 32) {
                addConsoleOutput('week4', 'Producer 1 FINISHED - produced 10 items', 'producer');
                addConsoleOutput('week4', 'Producer 2 FINISHED - produced 10 items', 'producer');
                addConsoleOutput('week4', 'Producer 3 FINISHED - produced 10 items', 'producer');
                
                // Update thread states
                week.producers[0].state = 'terminated';
                week.producers[1].state = 'terminated';
                week.producers[2].state = 'terminated';
            } else if (week.step === 33) {
                addConsoleOutput('week4', 'Consumer 1 finished (consumed 10 items)', 'consumer');
                addConsoleOutput('week4', 'Consumer 2 finished (consumed 10 items)', 'consumer');
                addConsoleOutput('week4', 'Consumer 3 finished (consumed 10 items)', 'consumer');
                
                // Update thread states
                week.consumers[0].state = 'terminated';
                week.consumers[1].state = 'terminated';
                week.consumers[2].state = 'terminated';
            } else if (week.step === 34) {
                addConsoleOutput('week4', 'All threads completed. Waiting for safe cleanup...', 'system');
                addConsoleOutput('week4', '[Preemption DISABLED]', 'system');
                addConsoleOutput('week4', 'Cleanup completed safely.', 'system');
            } else if (week.step === 35) {
                addConsoleOutput('week4', '=== Thread Statistics ===', 'system');
                addConsoleOutput('week4', 'Threads created: 6', 'system');
                addConsoleOutput('week4', 'Threads terminated: 6', 'system');
                addConsoleOutput('week4', 'Total context switches: 126', 'system');
                addConsoleOutput('week4', '  Voluntary yields: 60', 'system');
                addConsoleOutput('week4', '  Preemptions: 0', 'system');
                addConsoleOutput('week4', '  Mutex blocks: 0', 'system');
                addConsoleOutput('week4', 'Active threads: 0', 'system');
                addConsoleOutput('week4', 'Preemption enabled: NO', 'system');
                addConsoleOutput('week4', 'Multi-core enabled: NO', 'system');
                addConsoleOutput('week4', 'Kernel threads: 0', 'system');
                addConsoleOutput('week4', 'Scheduling policy: Priority', 'system');
                addConsoleOutput('week4', 'Test finished safely.', 'system');
            } else if (week.step === 36) {
                addConsoleOutput('week4', 'ðŸŽ‰ ALL TESTS COMPLETED! ðŸŽ‰', 'success');
            }
            
            // Update progress
            const progress = (week.step / 36) * 100;
            document.getElementById('week4-progress').style.width = `${Math.min(100, progress)}%`;
        }

        // Update buffer display for Week 4
        function updateBufferDisplay() {
            const bufferItems = document.getElementById('week4-buffer-items').children;
            const week = visualizationState.week4;
            
            for (let i = 0; i < bufferItems.length; i++) {
                if (week.buffer[i] !== 0) {
                    bufferItems[i].textContent = week.buffer[i];
                    bufferItems[i].classList.add('filled');
                } else {
                    bufferItems[i].textContent = '';
                    bufferItems[i].classList.remove('filled');
                }
            }
        }

        // Add console output
        function addConsoleOutput(weekId, text, type) {
            const consoleEl = document.getElementById(`${weekId}-console`);
            const line = document.createElement('div');
            line.className = `console-line console-${type}`;
            line.textContent = text;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        // Clear all consoles
        function clearConsoles() {
            document.getElementById('week1-console').innerHTML = '';
            document.getElementById('week2-console').innerHTML = '';
            document.getElementById('week3-console').innerHTML = '';
            document.getElementById('week4-console').innerHTML = '';
        }

        // Update all displays
        function updateAllDisplays() {
            updateWeek1Display();
            updateWeek2Display();
            updateWeek3Display();
            updateWeek4Display();
            updateOverallStats();
            updateThreadVisualizations();
        }

        // Update Week 1 display
        function updateWeek1Display() {
            const week = visualizationState.week1;
            document.getElementById('week1-created').textContent = week.stats.created;
            document.getElementById('week1-terminated').textContent = week.stats.terminated;
            document.getElementById('week1-switches').textContent = week.stats.switches;
            document.getElementById('week1-yields').textContent = week.stats.yields;
        }

        // Update Week 2 display
        function updateWeek2Display() {
            const week = visualizationState.week2;
            document.getElementById('week2-counter').textContent = week.stats.counter;
            document.getElementById('week2-preemptions').textContent = week.stats.preemptions;
            document.getElementById('week2-mutex-blocks').textContent = week.stats.mutexBlocks;
            document.getElementById('week2-switches').textContent = week.stats.switches;
        }

        // Update Week 3 display
        function updateWeek3Display() {
            const week = visualizationState.week3;
            document.getElementById('week3-switches').textContent = week.stats.switches;
        }

        // Update Week 4 display
        function updateWeek4Display() {
            const week = visualizationState.week4;
            document.getElementById('week4-produced').textContent = week.stats.produced;
            document.getElementById('week4-consumed').textContent = week.stats.consumed;
        }

        // Update overall statistics
        function updateOverallStats() {
            const week1 = visualizationState.week1.stats;
            const week2 = visualizationState.week2.stats;
            const week3 = visualizationState.week3.stats;
            const week4 = visualizationState.week4.stats;
            
            document.getElementById('total-created').textContent = week1.created + 2 + 3 + 6;
            document.getElementById('total-terminated').textContent = week1.terminated + 2 + 3 + 6;
            document.getElementById('total-switches').textContent = week1.switches + week2.switches + week3.switches + 126;
            document.getElementById('total-preemptions').textContent = week2.preemptions;
        }

        // Update thread visualizations
        function updateThreadVisualizations() {
            // Week 1
            visualizationState.week1.threads.forEach(thread => {
                const threadEl = document.getElementById(`week1-thread-${thread.id}`);
                if (threadEl) {
                    threadEl.className = `thread thread-${thread.state}`;
                    if (thread.state === 'running') {
                        threadEl.classList.add('pulse');
                    } else {
                        threadEl.classList.remove('pulse');
                    }
                }
            });

            // Week 2
            visualizationState.week2.threads.forEach(thread => {
                const threadEl = document.getElementById(`week2-thread-${thread.id}`);
                if (threadEl) {
                    threadEl.className = `thread thread-${thread.state}`;
                    if (thread.state === 'running') {
                        threadEl.classList.add('pulse');
                    } else {
                        threadEl.classList.remove('pulse');
                    }
                }
            });

            // Week 3
            visualizationState.week3.threads.forEach(thread => {
                const threadEl = document.getElementById(`week3-thread-${thread.id}`);
                if (threadEl) {
                    threadEl.className = `thread thread-${thread.state}`;
                    if (thread.state === 'running') {
                        threadEl.classList.add('pulse');
                    } else {
                        threadEl.classList.remove('pulse');
                    }
                }
            });

            // Week 4
            [...visualizationState.week4.producers, ...visualizationState.week4.consumers].forEach(thread => {
                const threadEl = document.getElementById(`week4-thread-${thread.id}`);
                if (threadEl) {
                    threadEl.className = `thread thread-${thread.state}`;
                    if (thread.state === 'running') {
                        threadEl.classList.add('pulse');
                    } else {
                        threadEl.classList.remove('pulse');
                    }
                }
            });
        }

        // Initialize on load
        window.onload = function() {
            initializeVisualization();
            // Auto-start after a brief delay
            setTimeout(startVisualization, 1000);
        };
    </script>
</body>
</html>